<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŸºé‡‘çœ‹æ¿ Pro - æ‰‹æœºå¢å¼ºç‰ˆ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>

    <style>
        :root { --up: #d93025; --down: #188038; --primary: #007bff; --bg: #f4f6f8; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: #333; -webkit-tap-highlight-color: transparent; }
        
        /* é¡¶éƒ¨ç»Ÿè®¡æ  */
        .header { background: #fff; padding: 20px 15px; position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: flex-end; }
        .total-val { font-size: 26px; font-weight: 800; }
        .profit-bar { font-size: 13px; font-weight: 600; padding: 4px 10px; border-radius: 6px; margin-top: 8px; display: inline-block; }
        
        /* åŸºé‡‘åˆ—è¡¨ */
        .list { padding: 12px; display: flex; flex-direction: column; gap: 12px; padding-bottom: 80px; }
        .card { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid transparent; }
        .card:active { background: #f0f0f0; border-color: #eee; }
        .card-main { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .f-name { font-size: 16px; font-weight: bold; max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .f-rate { font-size: 22px; font-weight: bold; font-family: monospace; }
        
        /* é¢œè‰²ç±» */
        .up { color: var(--up); } .down { color: var(--down); }
        .bg-up { background: rgba(217,48,37,0.1); color: var(--up); }
        .bg-down { background: rgba(24,128,56,0.1); color: var(--down); }

        /* æ‚¬æµ®æŒ‰é’® */
        .fab { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 4px 15px rgba(0,123,255,0.4); border: none; z-index: 99; }

        /* å…¨å±é¢æ¿å®¹å™¨ */
        .panel { position: fixed; inset: 0; background: #fff; z-index: 1000; display: none; flex-direction: column; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .panel.active { display: flex; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 32px; color: #ccc; border: none; background: none; line-height: 1; }
        
        /* è¶‹åŠ¿å›¾ä¸“ç”¨é…ç½® */
        .chart-container { flex: 1; min-height: 280px; position: relative; margin-top: 30px; }
        #trendChart { touch-action: none; width: 100% !important; height: 100% !important; } 

        /* è¡¨å•æ ·å¼ */
        input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .btn-submit { background: var(--primary); color: #fff; padding: 16px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; width: 100%; margin-top: 15px; }
        .chart-hint { font-size: 11px; color: #bbb; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <div style="font-size:12px; color:#999">æŒä»“æ€»ä¼°å€¼ (å…ƒ)</div>
            <div class="total-val" id="total_val">0.00</div>
            <div id="total_profit" class="profit-bar">ä»Šæ—¥åˆè®¡é¢„è®¡: --</div>
        </div>
        <div onclick="initData()" style="font-size: 24px; padding: 10px; cursor: pointer;">ğŸ”„</div>
    </div>

    <div class="list" id="fund_list">
        <div style="text-align:center; padding:50px; color:#999;">æ­£åœ¨åŠ è½½æ•°æ®çº¿è·¯...</div>
    </div>

    <button class="fab" onclick="showEdit()">+</button>

    <div id="edit_panel" class="panel">
        <button class="close-btn" onclick="closePanel('edit_panel')">Ã—</button>
        <h2 style="margin-top:0">ç®¡ç†åŸºé‡‘æŒä»“</h2>
        <input type="number" id="in_code" placeholder="6ä½åŸºé‡‘ä»£ç  (å¦‚ 012414)">
        <input type="text" id="in_name" placeholder="å¤‡æ³¨åç§° (å¯é€‰)">
        <input type="number" id="in_share" step="0.0001" placeholder="æŒæœ‰ä»½é¢">
        <input type="hidden" id="edit_idx">
        <button class="btn-submit" onclick="save()">ä¿å­˜å¹¶æ›´æ–°åˆ—è¡¨</button>
        <button id="del_btn" style="color:red; background:none; border:1px solid red; padding:12px; border-radius:10px; margin-top:20px; width:100%" onclick="remove()">åˆ é™¤æ­¤åŸºé‡‘</button>
    </div>

    <div id="chart_panel" class="panel">
        <button class="close-btn" onclick="closePanel('chart_panel')">Ã—</button>
        <h3 id="chart_name" style="margin-bottom:0">å†å²è¶‹åŠ¿</h3>
        <p id="chart_code" style="color:#999; font-size:12px; margin-top:5px"></p>
        
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
        
        <div class="chart-hint">ğŸ’¡ å·¦å³æ»‘åŠ¨å¹³ç§»ï¼ŒåŒæŒ‡æåˆç¼©æ”¾æ—¶é—´è½´</div>
        <button class="btn-submit" style="background:#f0f0f0; color:#333; margin-top:15px;" onclick="safeResetZoom()">é‡ç½®è§†å›¾</button>
    </div>

    <script>
        // ã€æ ¸å¿ƒä¿®å¤ï¼šæ³¨å†Œç¼©æ”¾æ’ä»¶ã€‘
        Chart.register(ChartZoom);

        let myFunds = JSON.parse(localStorage.getItem('hentao_mobile_v4')) || [];
        let chartInstance = null;

        // ã€ä¼˜åŒ–ï¼šæ™ºèƒ½å¤šä»£ç†åˆ‡æ¢ã€‘
        async function smartFetch(url) {
            const proxies = [
                "https://corsproxy.io/?",
                "https://api.codetabs.com/v1/proxy?quest=",
                "https://api.allorigins.win/raw?url="
            ];
            for (const proxy of proxies) {
                try {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ—¶
                    const res = await fetch(proxy + encodeURIComponent(url), { signal: controller.signal });
                    clearTimeout(id);
                    if (res.ok) return await res.text();
                } catch (e) { continue; }
            }
            throw new Error("æ¥å£å½“å‰ç¹å¿™");
        }

        // åˆå§‹åŒ–/åˆ·æ–°åˆ—è¡¨
        async function initData() {
            const listDiv = document.getElementById('fund_list');
            if (myFunds.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center;padding:50px;color:#999">æš‚æ— æŒä»“<br>ç‚¹å‡»ä¸‹æ–¹ + æ·»åŠ åŸºé‡‘</div>';
                return;
            }
            listDiv.innerHTML = '<div style="text-align:center;padding:50px;color:#999">æ­£åœ¨å®‰å…¨åŒæ­¥ä¼°å€¼...</div>';

            const tasks = myFunds.map(async f => {
                const url = `https://fundgz.1234567.com.cn/js/${f.code}.js?rt=${Date.now()}`;
                try {
                    const text = await smartFetch(url);
                    const match = text.match(/jsonpgz\((.*)\)/);
                    return { ...f, ...JSON.parse(match[1]), ok: true };
                } catch (e) { return { ...f, ok: false }; }
            });

            const results = await Promise.all(tasks);
            render(results);
        }

        // æ¸²æŸ“åˆ—è¡¨
        function render(data) {
            let totalVal = 0, totalProfit = 0;
            const listDiv = document.getElementById('fund_list');
            listDiv.innerHTML = '';

            data.forEach((item, i) => {
                if (!item.ok) {
                    listDiv.innerHTML += `<div class="card" onclick="showEdit(${i})">${item.code} åŠ è½½ä¸­... (ç‚¹å‡»ç¼–è¾‘)</div>`;
                    return;
                }
                const rate = parseFloat(item.gszzl);
                const share = parseFloat(item.share || 0);
                const marketVal = share * parseFloat(item.gsz);
                const profit = share * (parseFloat(item.gsz) - parseFloat(item.dwjz));
                totalVal += marketVal; totalProfit += profit;

                const clr = rate >= 0 ? 'up' : 'down';
                const bgClr = rate >= 0 ? 'bg-up' : 'bg-down';

                listDiv.innerHTML += `
                    <div class="card" onclick="viewTrend('${item.code}', '${item.name}')">
                        <div class="card-main">
                            <div class="f-name">${item.name}</div>
                            <div class="f-rate ${clr}">${rate > 0 ? '+' : ''}${item.gszzl}%</div>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:13px; color:#666">
                            <div>ä¼°å€¼: <span style="font-weight:bold;color:#333">${marketVal.toFixed(2)}</span></div>
                            <div class="${bgClr} profit-bar" style="margin:0; padding:2px 6px">
                                ä»Šæ—¥: ${(profit >= 0 ? '+' : '') + profit.toFixed(2)}
                            </div>
                        </div>
                        <div style="font-size:11px; color:#ccc; margin-top:10px" onclick="event.stopPropagation();showEdit(${i})">ç®¡ç†é…ç½® âœ</div>
                    </div>
                `;
            });
            document.getElementById('total_val').innerText = totalVal.toFixed(2);
            const pDom = document.getElementById('total_profit');
            pDom.innerText = `ä»Šæ—¥åˆè®¡é¢„è®¡: ${(totalProfit >= 0 ? '+' : '') + totalProfit.toFixed(2)}`;
            pDom.className = `profit-bar ${totalProfit >= 0 ? 'bg-up' : 'bg-down'}`;
        }

        // ================== äº¤äº’å¼è¶‹åŠ¿å›¾æ ¸å¿ƒ ==================

        async function viewTrend(code, name) {
            document.getElementById('chart_panel').classList.add('active');
            document.getElementById('chart_name').innerText = name + " (åŒæ­¥ä¸­...)";
            document.getElementById('chart_code').innerText = code;
            
            if (chartInstance) chartInstance.destroy();
            chartInstance = null;

            // å¢åŠ ç¼“å­˜æœºåˆ¶ï¼šåŒæ—¥ä¸å†é‡å¤è¯·æ±‚æ•°æ®
            const cacheKey = `f_cache_${code}`;
            const today = new Date().toLocaleDateString();
            const cached = JSON.parse(localStorage.getItem(cacheKey));

            if (cached && cached.date === today) {
                renderChart(cached.data, name);
                return;
            }

            try {
                const url = `https://fund.eastmoney.com/pingzhongdata/${code}.js`;
                const rawJs = await smartFetch(url);
                const match = rawJs.match(/var Data_netWorthTrend = (\[.*?\]);/);
                const fullData = JSON.parse(match[1]).slice(-200); // å–æœ€è¿‘200å¤©æ•°æ®ï¼Œç¼©æ”¾æ›´æ˜æ˜¾

                localStorage.setItem(cacheKey, JSON.stringify({ date: today, data: fullData }));
                renderChart(fullData, name);
            } catch (e) {
                document.getElementById('chart_name').innerText = "è¶‹åŠ¿åŠ è½½ç¹å¿™ï¼Œè¯·é‡è¯•";
            }
        }

        function renderChart(recentData, name) {
            document.getElementById('chart_name').innerText = name;
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recentData.map(d => new Date(d.x).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'})),
                    datasets: [{
                        data: recentData.map(d => d.y),
                        borderColor: '#007bff',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        zoom: {
                            pan: { enabled: true, mode: 'x', threshold: 5 },
                            zoom: {
                                pinch: { enabled: true }, // å¼€å¯æåˆç¼©æ”¾
                                wheel: { enabled: true },
                                mode: 'x'
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { autoSkip: true, maxRotation: 0 } },
                        y: { position: 'right', grid: { color: '#f0f0f0' } }
                    }
                }
            });
        }

        // ã€ä¿®å¤ï¼šå®‰å…¨é‡ç½®è§†å›¾ã€‘
        function safeResetZoom() {
            if (chartInstance) chartInstance.resetZoom();
        }

        // ================== é¢æ¿ä¸æ•°æ®å­˜å‚¨é€»è¾‘ ==================

        function showEdit(idx = null) {
            const p = document.getElementById('edit_panel');
            p.classList.add('active');
            if (idx !== null) {
                const f = myFunds[idx];
                document.getElementById('in_code').value = f.code;
                document.getElementById('in_name').value = f.name || '';
                document.getElementById('in_share').value = f.share || '';
                document.getElementById('edit_idx').value = idx;
                document.getElementById('del_btn').style.display = 'block';
            } else {
                document.querySelectorAll('#edit_panel input').forEach(i => i.value = '');
                document.getElementById('edit_idx').value = '';
                document.getElementById('del_btn').style.display = 'none';
            }
        }

        function closePanel(id) { document.getElementById(id).classList.remove('active'); }

        function save() {
            const code = document.getElementById('in_code').value.trim();
            const name = document.getElementById('in_name').value.trim();
            const share = document.getElementById('in_share').value.trim();
            const idx = document.getElementById('edit_idx').value;

            if (code.length < 6) return alert("è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç ");
            
            const obj = { code, name: name || code, share: parseFloat(share) || 0 };
            
            if (idx === "") myFunds.push(obj);
            else myFunds[idx] = obj;

            localStorage.setItem('hentao_mobile_v4', JSON.stringify(myFunds));
            closePanel('edit_panel');
            initData();
        }

        function remove() {
            const idx = document.getElementById('edit_idx').value;
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æŒä»“è®°å½•å—ï¼Ÿ')) {
                myFunds.splice(idx, 1);
                localStorage.setItem('hentao_mobile_v4', JSON.stringify(myFunds));
                closePanel('edit_panel');
                initData();
            }
        }

        // å¯åŠ¨ï¼
        initData();
    </script>
</body>
</html>